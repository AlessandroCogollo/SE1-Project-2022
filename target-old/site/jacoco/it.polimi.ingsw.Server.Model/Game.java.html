<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Game.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AM56</a> &gt; <a href="index.source.html" class="el_package">it.polimi.ingsw.Server.Model</a> &gt; <span class="el_source">Game.java</span></div><h1>Game.java</h1><pre class="source lang-java linenums">package it.polimi.ingsw.Server.Model;

import it.polimi.ingsw.Server.Errors;

//todo calc influence little method, finish check win, better main function, common check in character, javadoc

// This class is the interface towards the controller. It also check if the move from player/controller are valid. The only methods tha can be invoked from the controller are the factory method for getting a Game Instance or and advanced one, and the method for the possible interactions of users to the model
public class Game{

    private final int numOfPlayer;

    protected final GameInitializer gameInit;
    protected final RoundHandler round;

<span class="fc" id="L15">    Game (int numOfPlayer, GameInitializer gameInit, RoundHandler round) {</span>
<span class="fc" id="L16">        this.numOfPlayer = numOfPlayer;</span>
<span class="fc" id="L17">        this.gameInit = gameInit;</span>
<span class="fc" id="L18">        this.round = round;</span>
<span class="fc" id="L19">    }</span>


    public int playAssistant (int playerId, int assistantValue){

<span class="fc bfc" id="L24" title="All 2 branches covered.">        if (!gameInit.existsPlayer(playerId))</span>
<span class="fc" id="L25">            return Errors.PLAYER_NOT_EXIST.getCode();</span>
<span class="pc bpc" id="L26" title="1 of 4 branches missed.">        if (assistantValue &lt; 1 || assistantValue &gt; Assistant.getNumberOfAssistants())</span>
<span class="fc" id="L27">            return Errors.NOT_VALID_ASSISTANT.getCode();</span>

<span class="fc" id="L29">        Player p = gameInit.getPlayerById(playerId);</span>
<span class="fc" id="L30">        Assistant assistant = Assistant.getAssistantByValue(assistantValue);</span>

        // check if it's a possible moves
<span class="fc bfc" id="L33" title="All 2 branches covered.">        if (!p.equals(round.getCurrent()))</span>
<span class="fc" id="L34">            return Errors.NOT_CURRENT_PLAYER.getCode();</span>
<span class="fc bfc" id="L35" title="All 2 branches covered.">        if (!round.getPhase().equals(Phase.Planning))</span>
<span class="fc" id="L36">            return Errors.NOT_RIGHT_PHASE.getCode();</span>
<span class="fc bfc" id="L37" title="All 2 branches covered.">        if (!p.hasAssistant(assistant))</span>
<span class="fc" id="L38">            return Errors.NO_SUCH_ASSISTANT.getCode();</span>
<span class="fc bfc" id="L39" title="All 2 branches covered.">        if (!round.canPLayAssistant(p, assistant))</span>
<span class="fc" id="L40">            return Errors.ASSISTANT_ALREADY_PLAYED.getCode();</span>

        // call the correct method in player to modify the model
<span class="fc" id="L43">        p.playAssistant(assistant);</span>

        // update the round handler
<span class="fc" id="L46">        round.next();</span>

<span class="fc" id="L48">        return Errors.NO_ERROR.getCode();</span>
    }

    public int moveStudent(int playerId, int colorId, int destinationId){

<span class="fc bfc" id="L53" title="All 2 branches covered.">        if (!gameInit.existsPlayer(playerId))</span>
<span class="fc" id="L54">            return Errors.PLAYER_NOT_EXIST.getCode();</span>
<span class="pc bpc" id="L55" title="1 of 4 branches missed.">        if (colorId &lt; 0 || colorId &gt; Color.getNumberOfColors())</span>
<span class="fc" id="L56">            return Errors.NOT_VALID_COLOR.getCode();</span>
<span class="pc bpc" id="L57" title="1 of 4 branches missed.">        if (destinationId != -1 &amp;&amp; !gameInit.getIslands().existsIsland(destinationId))</span>
<span class="fc" id="L58">            return Errors.NOT_VALID_DESTINATION.getCode();</span>

<span class="fc" id="L60">        Player p = gameInit.getPlayerById(playerId);</span>
<span class="fc" id="L61">        Color c = Color.getColorById(colorId);</span>

<span class="pc bpc" id="L63" title="1 of 2 branches missed.">        if (!p.equals(round.getCurrent()))</span>
<span class="nc" id="L64">            return Errors.NOT_CURRENT_PLAYER.getCode();</span>
<span class="pc bpc" id="L65" title="1 of 4 branches missed.">        if (!round.getPhase().equals(Phase.Action) || !round.getActionPhase().equals(ActionPhase.MoveStudent))</span>
<span class="fc" id="L66">            return Errors.NOT_RIGHT_PHASE.getCode();</span>

        //check if the player can still move student
        //the check is already done in round handler and this one is redundant because if you have already move all the students in this turn the phase is automatically updated
<span class="fc" id="L70">        int movementDone = round.getStudentMovedInThisTurn();</span>
<span class="pc bpc" id="L71" title="2 of 10 branches missed.">        if (((numOfPlayer == 2 || numOfPlayer == 4) &amp;&amp; movementDone &gt;= 3) || (numOfPlayer == 3 &amp;&amp; movementDone &gt;= 4))</span>
<span class="nc" id="L72">            return Errors.NO_MORE_MOVEMENT.getCode();</span>

        //check if the player has the student that he wants to move
<span class="fc bfc" id="L75" title="All 2 branches covered.">        if (!p.hasStudent(c))</span>
<span class="fc" id="L76">            return Errors.NO_STUDENT.getCode();</span>

        //check if student has already 10 student of that color in the room
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">        if (p.getNumberOfStudentInRoomByColor(c) == 10)</span>
<span class="nc" id="L80">            return Errors.MAX_STUDENT_ROOM.getCode();</span>


        // call the player for move the student
<span class="fc" id="L84">        p.moveStudent(c, destinationId);</span>

<span class="fc" id="L86">        round.next();</span>

<span class="fc" id="L88">        return Errors.NO_ERROR.getCode();</span>
    }

    public int moveMotherNature (int playerId, int position){

<span class="fc bfc" id="L93" title="All 2 branches covered.">        if (!gameInit.existsPlayer(playerId))</span>
<span class="fc" id="L94">            return Errors.PLAYER_NOT_EXIST.getCode();</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">        if (position &lt; 1)</span>
<span class="fc" id="L96">            return Errors.MOVEMENT_NOT_VALID.getCode();</span>

<span class="fc" id="L98">        Player p = gameInit.getPlayerById(playerId);</span>

<span class="fc bfc" id="L100" title="All 2 branches covered.">        if (!p.equals(round.getCurrent()))</span>
<span class="fc" id="L101">            return Errors.NOT_CURRENT_PLAYER.getCode();</span>
<span class="fc bfc" id="L102" title="All 4 branches covered.">        if (!round.getPhase().equals(Phase.Action) || !round.getActionPhase().equals(ActionPhase.MoveMotherNature))</span>
<span class="fc" id="L103">            return Errors.NOT_RIGHT_PHASE.getCode();</span>

<span class="fc bfc" id="L105" title="All 2 branches covered.">        if (position &gt; p.getActiveAssistant().getMaxMovement())</span>
<span class="fc" id="L106">            return Errors.MOVEMENTS_TOO_HIGH.getCode();</span>

<span class="fc" id="L108">        p.moveMotherNature(position);</span>

<span class="fc" id="L110">        round.next();</span>

<span class="fc" id="L112">        return Errors.NO_ERROR.getCode();</span>
    }

    public int chooseCloud (int playerId, int cloudId){

<span class="fc bfc" id="L117" title="All 2 branches covered.">        if (!gameInit.existsPlayer(playerId))</span>
<span class="fc" id="L118">            return Errors.PLAYER_NOT_EXIST.getCode();</span>
<span class="fc bfc" id="L119" title="All 2 branches covered.">        if (!gameInit.getBoard().existsCloud(cloudId))</span>
<span class="fc" id="L120">            return Errors.NO_SUCH_CLOUD.getCode();</span>

<span class="fc" id="L122">        Player p = gameInit.getPlayerById(playerId);</span>
<span class="fc" id="L123">        Cloud c = gameInit.getBoard().getCloudById(cloudId);</span>

        // check if it's a possible moves
<span class="fc bfc" id="L126" title="All 2 branches covered.">        if (!p.equals(round.getCurrent()))</span>
<span class="fc" id="L127">            return Errors.NOT_CURRENT_PLAYER.getCode();</span>
<span class="pc bpc" id="L128" title="1 of 4 branches missed.">        if (!round.getPhase().equals(Phase.Action) || !round.getActionPhase().equals(ActionPhase.ChooseCloud))</span>
<span class="fc" id="L129">            return Errors.NOT_RIGHT_PHASE.getCode();</span>

<span class="fc" id="L131">        p.chooseCloud(c);</span>

<span class="fc" id="L133">        round.next();</span>

<span class="fc" id="L135">        return Errors.NO_ERROR.getCode();</span>
    }

    //return the correct interface for the parameter passed, in case of four player the teammates need to have the same final bit (in decimal same team all odds or all even, and the other team the opposite)
    static public Game getGameModel (int[] ids, int gameMode){

        //check game mode and number of player
<span class="pc bpc" id="L142" title="2 of 8 branches missed.">        if (gameMode &lt; 0 || gameMode &gt; 1 || ids.length &lt; 2 || ids.length &gt; 4)</span>
<span class="fc" id="L143">            return null;</span>

        //check id &gt; 0
<span class="fc" id="L146">        boolean allPositive = true;</span>
<span class="fc bfc" id="L147" title="All 2 branches covered.">        for (int id : ids)</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">            if (id &lt; 0) {</span>
<span class="fc" id="L149">                allPositive = false;</span>
<span class="fc" id="L150">                break;</span>
            }
<span class="fc bfc" id="L152" title="All 2 branches covered.">        if (!allPositive)</span>
<span class="fc" id="L153">            return null;</span>

        //check same id
<span class="fc" id="L156">        boolean sameId = false;</span>
<span class="fc bfc" id="L157" title="All 4 branches covered.">        for (int i = 0; i &lt; ids.length &amp;&amp; !sameId; i++) {</span>
<span class="fc bfc" id="L158" title="All 4 branches covered.">            for (int j = i + 1; j &lt; ids.length &amp;&amp; !sameId; j++){</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">                if (ids[i] == ids[j])</span>
<span class="fc" id="L160">                    sameId = true;</span>
            }
        }
<span class="fc bfc" id="L163" title="All 2 branches covered.">        if (sameId){</span>
<span class="fc" id="L164">            return null;</span>
        }

        //check odd and even for 4 player game
<span class="fc bfc" id="L168" title="All 2 branches covered.">        if (ids.length == 4){</span>
<span class="fc" id="L169">            int teamA = 0, teamB = 0;</span>
<span class="fc bfc" id="L170" title="All 2 branches covered.">            for (int i = 0; i &lt; 4; i++){</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">                if (ids[i] % 2 == 0){</span>
<span class="fc" id="L172">                    teamA++;</span>
                }
                else
<span class="fc" id="L175">                    teamB++;</span>
            }
<span class="pc bpc" id="L177" title="1 of 4 branches missed.">            if (teamA != 2 || teamB != 2)</span>
<span class="fc" id="L178">                return null;</span>
        }


<span class="fc" id="L182">        GameInitializer gInit = new GameInitializer(gameMode, ids.length);</span>

        //round handler is used for track the phase, the round, and the cycle of them
<span class="fc" id="L185">        RoundHandler roundHandler = new RoundHandler(gInit);</span>


        //game initializer create all the model
<span class="fc" id="L189">        gInit.createAllGame(ids, roundHandler);</span>
<span class="fc" id="L190">        roundHandler.start();</span>


        //advanced or normal game
<span class="fc bfc" id="L194" title="All 2 branches covered.">        if (gameMode == 0)</span>
<span class="fc" id="L195">            return new Game(ids.length, gInit, roundHandler);</span>
        else
<span class="fc" id="L197">            return new AdvancedGame(ids.length, gInit, roundHandler);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>