<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GameBoard.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AM56</a> &gt; <a href="index.source.html" class="el_package">it.polimi.ingsw.Server.Model</a> &gt; <span class="el_source">GameBoard.java</span></div><h1>GameBoard.java</h1><pre class="source lang-java linenums">package it.polimi.ingsw.Server.Model;

import java.lang.reflect.Array;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.Optional;

class GameBoard {

    private final GameInitializer gInit;
    private final ArrayList&lt;Cloud&gt; clouds;
    private final Collection&lt;Character&gt; charactersDeck;
    private final Islands islands;
    private final Professors professors;

    private Character activeCharacter;


<span class="fc" id="L20">    GameBoard (GameInitializer gInit){</span>

<span class="fc" id="L22">        this.gInit = gInit;</span>

<span class="fc" id="L24">        int numOfPlayer = gInit.getPlayersNumber();</span>
<span class="fc" id="L25">        this.clouds = new ArrayList&lt;&gt;(numOfPlayer);</span>
<span class="fc bfc" id="L26" title="All 2 branches covered.">        for(int i = 0; i &lt; numOfPlayer; i++){</span>
<span class="fc" id="L27">            clouds.add(new Cloud( i, gInit));</span>
        }
<span class="fc" id="L29">        this.charactersDeck = CharacterFactory.getNewGameDeck(gInit);</span>

<span class="fc" id="L31">        this.islands = gInit.getIslands();</span>
<span class="fc" id="L32">        this.professors = gInit.getProfessors();</span>
<span class="fc" id="L33">        this.activeCharacter = null;</span>
<span class="fc" id="L34">    }</span>


    Character getActiveCharacter() {
<span class="fc" id="L38">        return activeCharacter;</span>
    }

    boolean existsCloud (int cloudId){
<span class="fc" id="L42">        boolean exist = false;</span>
<span class="fc bfc" id="L43" title="All 2 branches covered.">        for (Cloud c: clouds)</span>
<span class="fc bfc" id="L44" title="All 2 branches covered.">            if (c.getId() == cloudId){</span>
<span class="fc" id="L45">                exist = true;</span>
<span class="fc" id="L46">                break;</span>
            }
<span class="fc" id="L48">        return exist;</span>
    }

    boolean existsCharacter (int characterId){
<span class="fc" id="L52">        boolean exists = false;</span>
<span class="fc bfc" id="L53" title="All 2 branches covered.">        for (Character c : charactersDeck)</span>
<span class="fc bfc" id="L54" title="All 2 branches covered.">            if (c.getId() == characterId){</span>
<span class="fc" id="L55">                exists = true;</span>
<span class="fc" id="L56">                break;</span>
            }
<span class="fc" id="L58">        return  exists;</span>
    }

    Cloud getCloudById(int cloudId) {
<span class="fc bfc" id="L62" title="All 2 branches covered.">        for (Cloud c: clouds)</span>
<span class="fc bfc" id="L63" title="All 2 branches covered.">            if (c.getId() == cloudId)</span>
<span class="fc" id="L64">                return c;</span>
<span class="fc" id="L65">        return null;</span>
    }

    Character getCharacterById(int characterId) {
<span class="fc bfc" id="L69" title="All 2 branches covered.">        for (Character x: charactersDeck)</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">            if (x.getId() == characterId)</span>
<span class="fc" id="L71">                return x;</span>
<span class="fc" id="L72">        return null;</span>
    }

    //reset all cloud at the end of a round
    void populateClouds(){
<span class="fc bfc" id="L77" title="All 2 branches covered.">        for(Cloud cloud : clouds){</span>
<span class="fc" id="L78">            cloud.setStudents();</span>
<span class="fc" id="L79">        }</span>
<span class="fc" id="L80">    }</span>

    void playCharacter(Character c, Object obj) {
<span class="fc" id="L83">        this.activeCharacter = c;</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">        if (c != null)</span>
<span class="fc" id="L85">            c.use(obj);</span>
<span class="fc" id="L86">    }</span>

    boolean isCharacterPlayed (){
<span class="fc bfc" id="L89" title="All 2 branches covered.">        return this.activeCharacter != null;</span>
    }

    void moveMotherNature(int count){

        //move mother nature of count position
<span class="fc" id="L95">        islands.nextMotherNature(count);</span>


<span class="fc" id="L98">        Island mN = islands.getMotherNature();</span>


<span class="pc bpc" id="L101" title="1 of 2 branches missed.">        if (mN.getBanCard() == 0){</span>
            //if there isn't the ban card

            //this modifies the island leaving it with the right tower in the end
<span class="fc" id="L105">            calcInfluence(mN);</span>

            //now we check if there are some aggregation to do, and we will do it
<span class="fc" id="L108">            islands.aggregateIsland(mN);</span>
        }
        else {
            //else only remove the banCard and return it to the apothecary
<span class="nc" id="L112">            mN.removeBanCard();</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">            for (Character c: charactersDeck)</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">                if (c.getId() == 0)</span>
<span class="nc" id="L115">                    ((Apothecary) c).addBanCard();</span>
        }

<span class="pc bpc" id="L118" title="1 of 2 branches missed.">        if (islands.getIslandsNumber() &lt;= 3)</span>
<span class="nc" id="L119">            gInit.checkWin();</span>
<span class="fc" id="L120">    }</span>


    //knight: adds 2 points to the current player (id = 7) --- OK
    //drunkard: given a color, blocks the influence calc for those students (id = 4) --- OK
    //minotaur: blocks the influence calc for the towers (id = 8) --- OK
    //cook: obtains the professor even if in withdraw in number of students in the room (id = 3) --- OK


    //returns the influence of each player
    HashMap&lt;Player, Integer&gt; getInfluenceMap(Island c){

<span class="fc" id="L132">        HashMap&lt;Player, Integer&gt; playersInfluence = new HashMap&lt;&gt;(gInit.getPlayersNumber()); // map of the influences</span>

        //initializing playersInfluence
<span class="fc bfc" id="L135" title="All 2 branches covered.">        for(Player p: gInit){</span>
<span class="fc" id="L136">            playersInfluence.put(p, 0);</span>
<span class="fc" id="L137">        }</span>

        /* Knight effect */
<span class="pc bpc" id="L140" title="1 of 4 branches missed.">        if( activeCharacter != null &amp;&amp; activeCharacter.getId()==7){</span>
<span class="nc" id="L141">            Player p = gInit.getRoundHandler().getCurrent();</span>
<span class="nc" id="L142">            playersInfluence.put(p, 2);</span>
        }

<span class="fc" id="L145">        int [] students = c.getStudents();</span>
        Player p;
        //fill the players influence array
<span class="fc" id="L148">        int temp = 0;</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">        for (int i = 0; i &lt; Color.getNumberOfColors(); i++){</span>

            /* Cook effect */
<span class="pc bpc" id="L152" title="3 of 6 branches missed.">            if(activeCharacter != null &amp;&amp; activeCharacter.getId() == 3 &amp;&amp; Color.getColorById(i).equals(((Cook) getActiveCharacter()).getProfessor())){</span>
<span class="nc" id="L153">                p = gInit.getRoundHandler().getCurrent(); //if i is the cook-color, p is the current player</span>
            }

            else{
<span class="fc" id="L157">                p = this.professors.getPlayerWithProfessor(Color.getColorById(i)); // else p is who owns the i-color</span>
            }
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">            if (p != null) { //if somebody owns the professor of the i-color</span>
<span class="nc" id="L160">                playersInfluence.replace(p, playersInfluence.get(p) + students[i]); // sum the influence of the player</span>
            }
        }

        /* Drunkard effect */
<span class="pc bpc" id="L165" title="1 of 4 branches missed.">        if(activeCharacter != null &amp;&amp; activeCharacter.getId() == 4){</span>
<span class="nc" id="L166">            p = this.professors.getPlayerWithProfessor(((Drunkard) getActiveCharacter()).getColor()); // p owns the drunkard-color</span>
<span class="nc" id="L167">            playersInfluence.replace(p, 0);</span>
        }
<span class="fc" id="L169">        return playersInfluence;</span>
    }

    // returns an ArrayList of int with the black, white and grey influences
    ArrayList&lt;Integer&gt; getInfluences(Island c){

        //get the influence of each player
<span class="fc" id="L176">        HashMap&lt;Player, Integer&gt; playersInfluence = getInfluenceMap(c);</span>

        //merging influences of mates
<span class="fc" id="L179">        int blackInfluence = 0, whiteInfluence = 0, greyInfluence = 0;</span>

<span class="fc bfc" id="L181" title="All 2 branches covered.">        for (Player k : gInit) {</span>
<span class="fc bfc" id="L182" title="All 2 branches covered.">            if (k.getTowerColor() == 1){ //if the k-player's color is black</span>
<span class="fc" id="L183">                blackInfluence = blackInfluence + playersInfluence.get(k);</span>
            }
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">            else if (k.getTowerColor() == 2){ //if the k-player's color is white</span>
<span class="fc" id="L186">                whiteInfluence = whiteInfluence + playersInfluence.get(k);</span>
            }
<span class="nc bnc" id="L188" title="All 2 branches missed.">            else if (k.getTowerColor() == 3){ //if the k-player's color is grey</span>
<span class="nc" id="L189">                greyInfluence = greyInfluence + playersInfluence.get(k);</span>
            }
<span class="fc" id="L191">        }</span>

        /*Minotaur effect*/
<span class="pc bpc" id="L194" title="1 of 4 branches missed.">        if(activeCharacter != null &amp;&amp; activeCharacter.getId() != 8) {</span>
            //if there are towers, add them to the influence
<span class="fc" id="L196">            int towerCount = c.getTowerCount();</span>
<span class="fc" id="L197">            int towerColor = c.getTowerColor();</span>
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">            if (towerCount&gt;0){</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">                if (towerColor == 1) blackInfluence = blackInfluence + towerCount;</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">                else if (towerColor == 2) whiteInfluence = whiteInfluence + towerCount;</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">                else if (towerColor == 3) greyInfluence = greyInfluence + towerCount;</span>
            }
        }

<span class="fc" id="L205">        ArrayList&lt;Integer&gt; influences = new ArrayList&lt;&gt;(Color.getNumberOfColors());</span>
<span class="fc" id="L206">        influences.add(blackInfluence);</span>
<span class="fc" id="L207">        influences.add(whiteInfluence);</span>
<span class="fc" id="L208">        influences.add(greyInfluence);</span>
<span class="fc" id="L209">        return influences;</span>
    }

    //replaces the current towers on the Island c with the ones of the player p
    void replaceTowers(Island c, Player p){
<span class="nc" id="L214">        int count = c.getTowerCount();</span>
        //the old towers come back to the owner
<span class="nc" id="L216">        Player owner = getPlayerWithTower(c.getTowerColor()).get(0);</span>
<span class="nc" id="L217">        owner.receiveTowerFromIsland(count);</span>
        //put the new towers
<span class="nc" id="L219">        p.moveTowerToIsland(count);</span>
<span class="nc" id="L220">        c.setTowerCount(count);</span>
<span class="nc" id="L221">        c.setTowerColor(p.getTowerColor());</span>
<span class="nc" id="L222">    }</span>

    //check if there's a tower to add or all towers to be replaced, and in that case does that
    void calcInfluence(Island c) {

<span class="fc" id="L227">        ArrayList&lt;Integer&gt; influences = getInfluences(c);</span>
<span class="fc" id="L228">        ArrayList&lt;Integer&gt; max = findMax(influences);</span>

        //in case of withdraw nothing changes, else:
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">        if (max.size() == 1){</span>
            //find a player who owns the max-influence tower color
<span class="nc" id="L233">            Player p = getPlayerWithTower(max.get(0)).get(0);</span>
            //if there is no tower, add it
<span class="nc bnc" id="L235" title="All 2 branches missed.">            if(c.getTowerCount() == 0){</span>
                //remove one tower from the player
<span class="nc" id="L237">                p.moveTowerToIsland(1);</span>
                //and added to the island
<span class="nc" id="L239">                c.setTowerCount(1);</span>
<span class="nc" id="L240">                c.setTowerColor(p.getTowerColor());</span>
            }
            //else if there are towers
            else {
                //if the max influence is different from the previous one, replace all the towers, and the tower count remains the same
<span class="nc bnc" id="L245" title="All 2 branches missed.">                if (max.get(0) != c.getTowerColor()) {</span>
<span class="nc" id="L246">                    replaceTowers(c,p);</span>
                }
                //else if the max influence remains the same nothing changes
            }
        }

<span class="fc" id="L252">    }</span>
    //returns an ArrayList with the players that owns the given tower color
    ArrayList&lt;Player&gt; getPlayerWithTower(int towerColor){
<span class="nc" id="L255">        ArrayList&lt;Player&gt; list = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">        for (Player p : gInit){</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">            if (p.getTowerColor() == towerColor){</span>
<span class="nc" id="L258">                list.add(p);</span>
            }
<span class="nc" id="L260">        }</span>
<span class="nc" id="L261">        return list;</span>
    }

    //returns the higher TowerColor
    private static ArrayList&lt;Integer&gt; findMax (ArrayList&lt;Integer&gt; influences){
<span class="fc" id="L266">        int max = 0;</span>
<span class="fc" id="L267">        int black = influences.get(0);</span>
<span class="fc" id="L268">        int white = influences.get(1);</span>
<span class="fc" id="L269">        int grey = influences.get(2);</span>
<span class="fc" id="L270">        ArrayList&lt;Integer&gt; temp = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L271" title="1 of 2 branches missed.">        if (black&gt;max) {</span>
<span class="nc" id="L272">            max = black;</span>
<span class="nc" id="L273">            temp.add(1);</span>
        }
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">        if (white&gt;max) {</span>
<span class="nc" id="L276">            max = white;</span>
<span class="nc" id="L277">            temp.clear();</span>
<span class="nc" id="L278">            temp.add(2);</span>
        }
<span class="pc bpc" id="L280" title="1 of 2 branches missed.">        else if (white == max){</span>
<span class="fc" id="L281">            temp.add(2);</span>
        }
<span class="pc bpc" id="L283" title="1 of 2 branches missed.">        if (grey&gt;max) {</span>
<span class="nc" id="L284">            temp.clear();</span>
<span class="nc" id="L285">            temp.add(3);</span>
        }
<span class="pc bpc" id="L287" title="1 of 2 branches missed.">        else if (grey == max){</span>
<span class="fc" id="L288">            temp.add(3);</span>
        }
<span class="fc" id="L290">        return temp;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>